# Use an official OpenJDK runtime as a parent image
FROM openjdk:17-jdk-alpine

# Install MySQL (or MariaDB)
RUN apk --no-cache add mariadb mariadb-client && \
    mkdir -p /run/mysqld && \
    chown -R mysql:mysql /run/mysqld && \
    mysql_install_db --user=mysql --datadir=/var/lib/mysql

# Set environment variables for MySQL
ENV MYSQL_ROOT_PASSWORD=rootpassword
ENV MYSQL_DATABASE=testdb

# Set the working directory inside the container
WORKDIR /app

# Copy the application JAR to the container
COPY target/*.jar /app/application.jar

# Expose ports (MySQL and Spring Boot)
EXPOSE 8080 3306

# Add a wait-for-it script to ensure MySQL is ready before Spring Boot starts
ADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /wait-for-it.sh
RUN chmod +x /wait-for-it.sh

# Start MySQL, wait for it to be ready, and then start the Spring Boot app
CMD mysqld --user=mysql --datadir=/var/lib/mysql & \
    echo "Waiting for MySQL to start..." && \
    /wait-for-it.sh localhost:3306 --timeout=60 --strict -- \
    echo "MySQL is up and running! Starting Spring Boot..." && \
    java -jar /app/application.jar
